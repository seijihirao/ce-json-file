<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<script>

/**
 * `CustomElements.AppJsonMixin` is a json file reader Mixin 
 * with its code based on polymer's' `Polymer.AppLocalizeMixin`
 * 
 * Sample application loading resources from an external file:
 *
 *	<dom-module id="x-app">
 *		<template>
 *			<div>[[json.name]]</div>
 *		</template>
 *		<script>
 *			Polymer({
 *				static get is(){ 'x-app' }
 *				
 *				static get properties(){
 *					return {
 *						file: {
 *							value: 'resources.json'
 *						}
 *					}
 *				}
 *			})
 *		&lt/script>
 *	</dom-module>
 *
 */
window.CustomElements = window.CustomElements || {}

/** @polymerMixin CustomElements.AppJsonMixin */
CustomElements.AppJsonMixin = (superclass) => class extends superclass {

	static get __requestCache() {
		return {
			requests: {},  /* One iron-request per unique resources path. */
			messages: {},  /* Unique localized strings. Invalidated when the language, formats or resources change. */
			ajax: null     /* Global iron-ajax object used to request resource files. */
		}
	}

	static get properties() {
		return {
			/**
			* The file to be read
			*/
			path: {
				type: String
			},
			/**
			* Json read from file
			*/
			json: {
				type: Object,
				notify: true
			}
		}
	}

	static get observers() {
		return [
			'_fileChanged(path)'
		]
	}
	
	/**
	 * Loads json file into json object
	 * 
	 * @param path
	 */
	loadJsonResources(path) {
		var proto = this.constructor.prototype

		// If the global ajax object has not been initialized, initialize and cache it.
		var ajax = proto.__requestCache.ajax
		if (!ajax) {
			ajax = proto.__requestCache.ajax = document.createElement('iron-ajax')
		}

		var request = proto.__requestCache.requests[path]
		if (!request) {
			ajax.url = path
			var request = ajax.generateRequest()

			request.completes.then(
					this.__onJsonRequestResponse.bind(this),
					this.__onJsonRequestError.bind(this))

			// Cache the instance so that it can be reused if the same path is loaded.
			proto.__requestCache.requests[path] = request
		} else {
			request.completes.then(
					this.__onJsonRequestResponse.bind(this),
					this.__onJsonRequestError.bind(this))
		}
	}

	__onJsonRequestResponse(event) {
		this.set('json', event.response)
		this.dispatchEvent(new CustomEvent('json-resources-loaded'))
	}

	__onJsonRequestError(event) {
		this.dispatchEvent(new CustomEvent('json-resources-error'))
	}

	_fileChanged(path) {
		this.loadJsonResources(this.resolveUrl(this.path))
	}

}

</script>
